# Migration 2.6: Labor Operations

## Overview

**Phase**: 2 - Core Estimating System  
**Sub-Phase**: 2.6 - Labor Operations Database  
**Created**: January 2025  
**Status**: Ready to Execute

## Purpose

Creates the labor operations system with industry-standard operations, categories, and rates. This enables auto-calculation of labor costs in estimates based on standardized hours and shop-specific rates.

## Tables Created

### 1. `LaborOperation`
Stores industry-standard labor operations with standardized hours.

**Columns**:
- `id` (TEXT, PRIMARY KEY) - Unique identifier
- `code` (TEXT, UNIQUE) - Operation code (e.g., "RB-001", "PT-004")
- `category` (TEXT) - Operation category: body, paint, mechanical, electrical, glass, frame, detail
- `operation` (TEXT) - Human-readable operation name
- `standardHours` (DECIMAL) - Industry-standard hours for this operation
- `difficulty` (TEXT, OPTIONAL) - Difficulty level: easy, medium, hard, expert
- `description` (TEXT, OPTIONAL) - Detailed description of the operation
- `createdAt` (TIMESTAMP) - Record creation timestamp
- `updatedAt` (TIMESTAMP) - Last update timestamp

**Indexes**:
- `idx_labor_operations_category` on `category`
- `idx_labor_operations_code` on `code` (unique)

### 2. `ShopSettings`
Stores shop-specific configuration including labor rates, tax settings, and business information.

**Columns**:
- `id` (TEXT, PRIMARY KEY) - Unique identifier
- `shopId` (TEXT, UNIQUE, FK → Shop.id) - Reference to shop
- `bodyLaborRate` (DECIMAL) - Rate for body work ($/hr)
- `paintLaborRate` (DECIMAL) - Rate for paint work ($/hr)
- `mechanicalLaborRate` (DECIMAL) - Rate for mechanical work ($/hr)
- `electricalLaborRate` (DECIMAL) - Rate for electrical work ($/hr)
- `glassLaborRate` (DECIMAL) - Rate for glass work ($/hr)
- `frameLaborRate` (DECIMAL) - Rate for frame work ($/hr)
- `detailLaborRate` (DECIMAL) - Rate for detail work ($/hr)
- `diagnosticRate` (DECIMAL) - Diagnostic fee (flat rate)
- `alignmentRate` (DECIMAL) - Alignment fee (flat rate)
- `paintMaterialsRate` (DECIMAL) - Paint materials markup (%)
- `shopSupplyFee` (DECIMAL) - Shop supply fee (flat rate or %)
- `defaultTaxRate` (DECIMAL) - Default sales tax rate
- `taxParts` (BOOLEAN) - Tax parts?
- `taxLabor` (BOOLEAN) - Tax labor?
- `taxPaint` (BOOLEAN) - Tax paint/materials?
- `shopName` (TEXT) - Business name
- `shopAddress` (TEXT) - Physical address
- `shopCity` (TEXT) - City
- `shopState` (TEXT) - State
- `shopZip` (TEXT) - ZIP code
- `shopPhone` (TEXT) - Phone number
- `shopEmail` (TEXT) - Email address
- `shopWebsite` (TEXT, OPTIONAL) - Website URL
- `createdAt` (TIMESTAMP) - Record creation timestamp
- `updatedAt` (TIMESTAMP) - Last update timestamp

**Indexes**:
- `idx_shop_settings_shop_id` on `shopId` (unique)

## Tables Modified

None - this is a new schema addition.

## Seed Data

### Labor Operations (50+ operations)

**Body Work** (12 operations):
- R&I Front Bumper Cover (1.5 hrs)
- R&I Rear Bumper Cover (1.5 hrs)
- R&I Hood (1.0 hrs)
- R&I Front Fender (2.0 hrs)
- R&I Door Panel (1.5 hrs)
- R&I Tailgate (1.5 hrs)
- R&I Headlights (0.5 hrs)
- R&I Taillights (0.5 hrs)
- R&I Mirror Assembly (0.5 hrs)
- Replace Front Bumper Reinforcement (2.5 hrs)
- Replace Radiator Support (4.0 hrs)
- Replace Door Shell (3.0 hrs)

**Paint Work** (8 operations):
- Paint Front Bumper (3.0 hrs)
- Paint Hood (3.5 hrs)
- Paint Door (4.0 hrs)
- Paint Fender (3.5 hrs)
- Paint Full Vehicle (24.0 hrs)
- Paint and Blend (6.0 hrs)
- Clear Coat Repair (2.0 hrs)
- Spot Paint Repair (1.5 hrs)

**Mechanical** (10 operations):
- Replace Radiator (2.5 hrs)
- Replace AC Condenser (3.0 hrs)
- Replace Cooling Fan Assembly (1.5 hrs)
- Replace Engine Mounts (4.0 hrs)
- Replace Transmission Mounts (3.0 hrs)
- Replace Exhaust System (3.5 hrs)
- Replace Fuel Tank (2.5 hrs)
- Replace Brake Lines (4.0 hrs)
- Replace Suspension Components (6.0 hrs)
- Replace Steering Components (5.0 hrs)

**Electrical** (8 operations):
- Diagnose Electrical Issue (1.0 hrs)
- Replace Wiring Harness (5.0 hrs)
- Replace Headlight Assembly (0.75 hrs)
- Replace Taillight Assembly (0.75 hrs)
- Replace Side Mirror (0.5 hrs)
- Replace Door Lock Actuator (1.5 hrs)
- Replace Window Motor/Regulator (2.0 hrs)
- Replace BCM/ECM (2.5 hrs)

**Glass** (5 operations):
- Replace Windshield (2.0 hrs)
- Replace Door Glass (1.5 hrs)
- Replace Quarter Glass (1.5 hrs)
- Replace Back Glass (2.0 hrs)
- Repair Windshield Chip (0.5 hrs)

**Frame** (4 operations):
- Frame Straightening (Minor) (8.0 hrs)
- Frame Straightening (Major) (16.0 hrs)
- Replace Frame Rail Section (12.0 hrs)
- Unibody Repair (10.0 hrs)

**Detail** (3 operations):
- Full Interior Detail (3.0 hrs)
- Full Exterior Detail (2.5 hrs)
- Complete Detail Package (5.0 hrs)

## Dependencies

**Required Migrations**:
- Phase 1.2: Shop Management (requires `Shop` table)

**Order**: Must run AFTER Phase 1 migrations.

## Rollback

To undo this migration:

```sql
-- Drop tables in reverse order
DROP TABLE IF EXISTS "ShopSettings";
DROP TABLE IF EXISTS "LaborOperation";

-- Drop indexes (if tables weren't dropped)
DROP INDEX IF EXISTS idx_labor_operations_category;
DROP INDEX IF EXISTS idx_labor_operations_code;
DROP INDEX IF EXISTS idx_shop_settings_shop_id;
```

## Verification

After running this migration, verify:

1. **Tables exist**:
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_name IN ('LaborOperation', 'ShopSettings');
   ```

2. **Labor operations seeded**:
   ```sql
   SELECT category, COUNT(*) as count 
   FROM "LaborOperation" 
   GROUP BY category;
   ```
   Expected: 7 categories with 50+ total operations

3. **Indexes created**:
   ```sql
   SELECT indexname FROM pg_indexes 
   WHERE tablename IN ('LaborOperation', 'ShopSettings');
   ```

## Integration

**API Endpoints**:
- `GET /api/labor-operations` - Fetch all labor operations
- `GET /api/shop-settings?shopId={id}` - Fetch shop settings
- `PUT /api/shop-settings` - Update shop settings

**Components**:
- `LaborOperationSelector.tsx` - Labor operation picker modal
- `ShopSettingsPage.tsx` - Settings management UI

**Calculation**:
- `calculateLaborCost()` in `lib/labor-operations.ts`
- Auto-calculates: `cost = hours × rate` (rate based on operation category)

## Notes

- Labor rates are shop-specific, not global
- Standard hours can be overridden per estimate line item
- Categories map to different labor rates (e.g., paint work costs more than body work)
- This follows industry standards from Mitchell, CCC ONE, Audatex

## Testing

1. Run migration
2. Verify all 50+ operations inserted
3. Create a shop settings record
4. Test labor cost calculation with different categories
5. Verify rates apply correctly per category

---

**Migration File**: `2.6-labor-operations.sql`  
**Last Updated**: January 2025
